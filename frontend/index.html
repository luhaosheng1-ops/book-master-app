<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯»ä¹¦è§£æ„å¤§å¸ˆ | Book Deconstruction Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #f4f1ea;
        }

        .prose {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            color: #2d3436;
        }

        .upload-area {
            border: 2px dashed #a29bfe;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background-color: #efedff;
            border-color: #6c5ce7;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6c5ce7;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“˜ è¯»ä¹¦è§£æ„å¤§å¸ˆ</h1>
            <p class="text-gray-500">ä¸Šä¼ ä¹¦ç±ï¼Œä¸€é”®ç”Ÿæˆæ·±åº¦çŸ¥è¯†æ‰‹å†Œ</p>
            <div id="configInfo" class="mt-4 text-xs text-gray-400">æ­£åœ¨è·å–è¾“å‡ºç›®å½•...</div>
        </header>

        <div id="dropZone" class="upload-area bg-white rounded-xl p-12 text-center cursor-pointer mb-8">
            <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt,.epub,.mobi,.azw3">
            <div id="uploadStatus">
                <p class="text-lg text-gray-600">å°†ç”µå­ä¹¦ (PDF/TXT/epub/mobi/azw3) æ‹–åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p class="text-sm text-gray-400 mt-2">æ”¯æŒ Z-Library ä¸‹è½½çš„å„ç±»æ–‡æ¡£</p>
            </div>
        </div>

        <div id="resultArea" class="hidden bg-white shadow-lg rounded-xl p-10 prose shadow-xl">
            <div class="flex justify-between items-center mb-8 border-b pb-4">
                <div class="flex flex-col">
                    <span class="text-sm text-gray-400">è§£æ„å®Œæˆï¼šå†…å®¹å·²åŒæ­¥è‡³æœ¬åœ°ç›®å½•</span>
                    <span id="savePath" class="text-xs text-indigo-400"></span>
                </div>
                <div class="space-x-2">
                    <button id="download-btn"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">ğŸ“¥ ä¸‹è½½ MD</button>
                    <button onclick="window.print()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm">ğŸ–¨ï¸ æ‰“å°
                        PDF</button>
                </div>
            </div>
            <div id="content"></div>
        </div>
    </div>
    <div id="result-container" style="display:none;">
        <h3>è§£æ„ç»“æœï¼š</h3>
        <pre id="output-text"></pre>
        <button id="download-btn" class="btn-success">ä¸‹è½½ Markdown æ–‡ä»¶</button>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const contentDiv = document.getElementById('content');
        const resultArea = document.getElementById('resultArea');
        const configInfo = document.getElementById('configInfo');
        const resultContainer = document.getElementById('result-container');
        const downloadBtn = document.getElementById('download-btn');

        // 1. è·å–é…ç½®ä¿¡æ¯ï¼ˆä½“ç°è®°å¿†åŠŸèƒ½ï¼‰
        fetch('http://localhost:8000/config')
            .then(r => r.json())
            .then(data => {
                configInfo.innerText = `å½“å‰è‡ªåŠ¨åŒæ­¥ç›®å½•ï¼š${data.current_output_dir}`;
            })
            .catch(err => console.error("æ— æ³•è·å–é…ç½®"));

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleUpload(e.target.files[0]);

        async function handleUpload(file) {
            if (!file) return;

            // ç•Œé¢åé¦ˆ
            document.getElementById('uploadStatus').innerHTML =
                '<div class="loading-spinner mx-auto mb-4"></div><p>æ­£åœ¨æ·±åº¦è§£æ„ä¸­ï¼Œè¯·ç¨å€™ï¼ˆé€šå¸¸éœ€è¦30-60ç§’ï¼‰...</p>';
            resultArea.classList.add('hidden');
            resultContainer.style.display = 'none';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    body: formData
                });

                const res = await response.json();

                if (response.ok && res.status === 'success') {
                    // --- å…³é”®ä¿®å¤ï¼šæ‰€æœ‰é€»è¾‘éƒ½è¦åœ¨æ‹¿åˆ° res ä¹‹åæ‰§è¡Œ ---

                    // 1. æ¸²æŸ“ Markdown åˆ°ä¸»å±•ç¤ºåŒº
                    const markdownText = res.content || res.data; // å…¼å®¹ content æˆ– data å­—æ®µ

                    // ã€æ–°å¢ã€‘ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                    localStorage.setItem('last_analysis_content', markdownText);
                    localStorage.setItem('last_analysis_filename', res.filename);

                    resultArea.classList.remove('hidden');
                    if (markdownText) {
                        contentDiv.innerHTML = marked.parse(markdownText);
                        resultArea.classList.remove('hidden');
                    } else {
                        console.error("åç«¯è¿”å›æ•°æ®ç»“æ„ä¸æ­£ç¡®:", res);
                        alert("è§£æ„æˆåŠŸä½†æœªè·å–åˆ°å†…å®¹æ–‡æœ¬");
                    }
                    // 2. æ˜¾ç¤ºä¸‹è½½å®¹å™¨å¹¶ç»‘å®šæ–‡ä»¶å
                    resultContainer.style.display = 'block';
                    document.getElementById('output-text').innerText = "å·²ç”Ÿæˆ Markdown æ–‡ä»¶ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½ã€‚";

                    // 3. ç»‘å®šä¸‹è½½æŒ‰é’® (ä½¿ç”¨åç«¯è¿”å›çš„ filename)
                    downloadBtn.onclick = () => {
                        window.location.href = `http://localhost:8000/download/${encodeURIComponent(res.filename)}`;
                    };

                    document.getElementById('uploadStatus').innerHTML =
                        '<p class="text-green-600 font-bold">è§£æ„æˆåŠŸï¼</p><p class="text-sm text-gray-400 mt-2">æ–‡ä»¶å·²å­˜å…¥æœ¬åœ°ï¼Œä¹Ÿå¯ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½</p>';

                    resultArea.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(res.detail || 'è§£æ„å¤±è´¥');
                }
                // ã€æ–°å¢ã€‘åœ¨é¡µé¢åŠ è½½å®Œæˆæ—¶ï¼ˆscript æ ‡ç­¾å¼€å¤´ï¼‰ï¼Œå°è¯•è¯»å–ç¼“å­˜ï¼š
                window.onload = () => {
                    const savedContent = localStorage.getItem('last_analysis_content');
                    const savedFilename = localStorage.getItem('last_analysis_filename');

                    if (savedContent) {
                        resultArea.classList.remove('hidden');
                        contentDiv.innerHTML = marked.parse(savedContent);
                        // é‡æ–°ç»‘å®šä¸‹è½½æŒ‰é’®
                        downloadBtn.onclick = () => {
                            window.location.href = `http://localhost:8000/download/${encodeURIComponent(savedFilename)}`;
                        };
                    }
                };
            } catch (error) {
                console.error(error);
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                document.getElementById('uploadStatus').innerHTML = '<p class="text-red-500">å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•</p>';
            }
        }
    </script>
</body>

</html>